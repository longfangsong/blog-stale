---
title: GraphQL with Go
date: 2018-09-02 00:00:00
tags: [Go, GraphQL]
mathjax: true
comments: true
summary: GraphQLå¤§å¤§æ”¹å˜äº†Webç¨‹åºå‘˜è·å–æ•°æ®çš„æ–¹å¼ï¼Œç”±åŸæ¥çš„â€œåç«¯å¼€æŸç±»æ¥å£ç»™å‰ç«¯â€å˜ä¸ºäº†â€œåç«¯å¼€GraphQLè®©å‰ç«¯è‡ªå·±æƒ³è¦å•¥æ‹¿å•¥â€ã€‚æœ¬æ–‡è®²è§£äº†GraphQLå¦‚ä½•ä¸Goè¯­è¨€é…åˆå·¥ä½œã€‚
---
<h2 id="GraphQL"><a class="headerlink" href="#GraphQL" title="GraphQL"></a>GraphQL</h2><blockquote>
<p>GraphQL æ˜¯ä¸€ä¸ªç”¨äº API çš„æŸ¥è¯¢è¯­è¨€ï¼Œæ˜¯ä¸€ä¸ªä½¿ç”¨åŸºäºç±»å‹ç³»ç»Ÿæ¥æ‰§è¡ŒæŸ¥è¯¢çš„æœåŠ¡ç«¯è¿è¡Œæ—¶ï¼ˆç±»å‹ç³»ç»Ÿç”±ä½ çš„æ•°æ®å®šä¹‰ï¼‰ã€‚GraphQL å¹¶æ²¡æœ‰å’Œä»»ä½•ç‰¹å®šæ•°æ®åº“æˆ–è€…å­˜å‚¨å¼•æ“ç»‘å®šï¼Œè€Œæ˜¯ä¾é ä½ ç°æœ‰çš„ä»£ç å’Œæ•°æ®æ”¯æ’‘ã€‚</p>
</blockquote>
<p>ä¸è¦å› ä¸ºåå­—é‡Œå¸¦ä¸ªQLå°±æŠŠå®ƒå’Œæ•°æ®åº“è”æƒ³èµ·æ¥äº†ï¼Œæ— è®ºå¦‚ä½•QLåªä»£è¡¨å®ƒæ˜¯ä¸€é—¨æŸ¥è¯¢è¯­è¨€ï¼ˆQuery Languageï¼‰ï¼Œå®ƒæ ¹æœ¬ä¸èƒ½ç›´æ¥ç¢°æ•°æ®åº“ã€‚</p>
<p>ï¼ˆä½ çœ‹çœ‹yamlï¼Œå°±å’Œhtmlé•¿å¾—ä¸€ç‚¹éƒ½ä¸åƒå¯¹ä¸å¯¹ï¼Œåå­—ä¸é‡è¦ã€‚ï¼‰</p>
<p>å¤§ä½“æ¥è¯´ï¼ŒGraphQLæ˜¯æƒ³è¦åšæ‰Restful APIçš„ã€‚</p>
<p>GraphQLæ˜¯ä¸€é—¨è¯­è¨€ï¼Œæœ‰ä¸€å®šçš„å¤æ‚æ€§ï¼Œåœ¨æ­¤ä¸è®²è§£å…¶è¯­æ³•ï¼Œè€Œåªåšæ¦‚å¿µä¸Šçš„è®²è§£ã€‚</p>
<p>è¦å­¦ä¹ å…¶è¯­æ³•çš„åŒå­¦ï¼Œå³è½¬<a href="http://graphql.cn/learn/" rel="noopener" target="_blank">å®˜ç½‘æ•™ç¨‹</a>ã€‚</p>
<h3 id="GraphQLçš„è¿ä½œè¿‡ç¨‹"><a class="headerlink" href="#GraphQLçš„è¿ä½œè¿‡ç¨‹" title="GraphQLçš„è¿ä½œè¿‡ç¨‹"></a>GraphQLçš„è¿ä½œè¿‡ç¨‹</h3><p>ä¸»è¦æ˜¯ï¼š</p>
<ul>
<li>åç«¯æ­å»ºGraphQLæœåŠ¡</li>
<li>å‰ç«¯å‘è¿™ä¸ªæœåŠ¡å‘é€GraphQLæŸ¥è¯¢å­—ç¬¦ä¸²</li>
<li>è¿™ä¸ªæœåŠ¡å‘åç«¯å…¶ä»–éƒ¨åˆ†æŸ¥è¯¢ä¸€æ•´ä¸ªGraphQLä¸­çš„â€œå¯¹è±¡â€ï¼ˆè¿™ä¸ªæ“ä½œå¯èƒ½ä¼šç»è¿‡ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å€¼ç„¶åæ‹¼è£…æˆå¯¹è±¡è¿™ç§ï¼‰</li>
<li>GraphQLæœåŠ¡è¿”å›ï¼ˆä¸”ä»…è¿”å›ï¼‰å‰ç«¯è¯·æ±‚çš„å€¼ï¼ˆå¸¸è§ç”¨æ³•æ˜¯åŒ…è£¹åœ¨JSONä¸­è¿”å›ï¼‰</li>
</ul>
<p><img alt="Route" src="./Route.svg"/></p>
<p>å½“ç„¶é™¤äº†æŸ¥è¯¢ä¹‹å¤–ï¼ŒGraphQLä¹Ÿæä¾›äº†<code>input</code>å’Œ<code>mutation</code>æ¥åˆ›å»ºã€ä¿®æ”¹æ•°æ®ã€‚ç”¨æ³•ä»ç„¶è§<a href="http://graphql.cn/learn/queries/#mutations" rel="noopener" target="_blank">å®˜ç½‘æ•™ç¨‹</a>ã€‚</p>
<h2 id="å‰ç«¯ä½¿ç”¨GraphQL"><a class="headerlink" href="#å‰ç«¯ä½¿ç”¨GraphQL" title="å‰ç«¯ä½¿ç”¨GraphQL"></a>å‰ç«¯ä½¿ç”¨GraphQL</h2><p>æ²¡å•¥å¥½è¯´çš„ï¼Œç›´æ¥å‘åç«¯å¼€çš„GraphQLæœåŠ¡ä¸Šå‘é€æŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œç„¶åç­‰ç€æ”¶å¯¹åº”çš„JSONæ•°æ®å°±è¡Œã€‚</p>
<p>è‡³äºå“ªç§ï¼ˆJSONï¼ŸTextï¼ŸFormDataï¼Ÿï¼‰è¿™ä¸ªæ²¡æœ‰è§„å®šï¼Œå’Œåç«¯çº¦å¥½äº†å°±è¡Œã€‚</p>
<p>å¦‚æœæœ‰é‰´æƒç›¸å…³çš„ä¸œè¥¿ï¼Œæ¯”å¦‚<code>JWT Token</code>ï¼Œåƒå¹³å¸¸ä¸€æ ·å‘ç»™åç«¯å°±è¡Œäº†ã€‚</p>
<p>ä¸è¿‡ï¼Œå‰ç«¯ç¡®å®éœ€è¦æŒæ¡GraphQLçš„è¯­æ³•â€¦â€¦æ‰€ä»¥æƒ³ç”¨çš„å‰ç«¯å¯ä»¥å»çœ‹ä¸€ä¸‹â€¦â€¦</p>
<h2 id="åç«¯ä½¿ç”¨GraphQLï¼ˆGoï¼‰"><a class="headerlink" href="#åç«¯ä½¿ç”¨GraphQLï¼ˆGoï¼‰" title="åç«¯ä½¿ç”¨GraphQLï¼ˆGoï¼‰"></a>åç«¯ä½¿ç”¨GraphQLï¼ˆGoï¼‰</h2><p>è¿™å¯æ˜¯è¦äº†äººè€å‘½äº†ã€‚</p>
<p>çœ‹çœ‹JSã€Pythoné‡ŒGraphQLçš„ä¼˜é›…å®ç°ï¼Œç”¨Goçš„åªèƒ½æ„Ÿå¹å½“åˆä¸ºä»€ä¹ˆè¦é€‰Goâ€¦â€¦</p>
<p>ï¼ˆä¸è¿‡ä½ ä»¬è¿™äº›ç”¨ JSã€Python çš„äººä¸€å®šä¼šåœ¨æ€§èƒ½ä¸Šè¢«Goç”¨æˆ·æ‰“çˆ†çš„ğŸ˜ï¼‰</p>
<p>ï¼ˆå–‚ï¼Œè®¿é—®é‡æ ¹æœ¬åˆ°ä¸äº†é‚£ä¸ªåœ°æ­¥å¥½å§â€¦â€¦ï¼‰</p>
<p>ä¸ç®¡æ€ä¹ˆæ ·ï¼Œè‡ªå·±é€‰çš„æŠ€æœ¯æ ˆè·ªç€ä¹Ÿè¦ç”¨å®Œã€‚</p>
<h3 id="è¦ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“"><a class="headerlink" href="#è¦ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“" title="è¦ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“"></a>è¦ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“</h3><p>ç›®å‰ä¸»æµçš„Go+GraphQLåº“æ˜¯ï¼š<a href="github.com/graphql-go/graphql">graphql-go</a>ã€‚</p>
<p>ç”¨è¿‡Goçš„éƒ½çŸ¥é“æ€ä¹ˆå®‰è£…ï¼Œ<code>go get</code>ä¸€æŠŠæ¢­å°±æ˜¯ã€‚</p>
<h3 id="å®šä¹‰GraphQLç±»å‹"><a class="headerlink" href="#å®šä¹‰GraphQLç±»å‹" title="å®šä¹‰GraphQLç±»å‹"></a>å®šä¹‰GraphQLç±»å‹</h3><p>ç”¨<code>graphql.NewObject</code>æ¥å®šä¹‰GraphQLç±»å‹ã€‚</p>
<p>å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> UserInfoType = graphql.NewObject(graphql.ObjectConfig{</span><br/><span class="line">	Name:        <span class="string">"user"</span>,</span><br/><span class="line">	Description: <span class="string">"ç”¨æˆ·ä¿¡æ¯æè¿°"</span>,</span><br/><span class="line">    <span class="comment">// GraphQLç±»å‹userçš„IDå­—æ®µ</span></span><br/><span class="line">	Fields: graphql.Fields{</span><br/><span class="line">		<span class="string">"Id"</span>: &amp;graphql.Field{</span><br/><span class="line">			Description: <span class="string">"ç”¨æˆ·ID"</span>,</span><br/><span class="line">			Type:        graphql.Int,</span><br/><span class="line">		},</span><br/><span class="line">		<span class="string">"CardId"</span>: &amp;graphql.Field{</span><br/><span class="line">			Description: <span class="string">"ç”¨æˆ·æ ¡å›­å¡å·"</span>,</span><br/><span class="line">			Type:        graphql.String,</span><br/><span class="line">		},</span><br/><span class="line">		<span class="string">"NickName"</span>: &amp;graphql.Field{</span><br/><span class="line">			Description: <span class="string">"ç”¨æˆ·æ˜µç§°"</span>,</span><br/><span class="line">			Type:        graphql.String,</span><br/><span class="line">		},</span><br/><span class="line">	},</span><br/><span class="line">})</span><br/></pre></td></tr></table></figure>
<p>å…¶å®è¿™æ ·å°±å¾ˆä¸èˆ’æœï¼Œè¦æ˜¯èƒ½åƒjsonå’Œormä¸€æ ·åœ¨å®šä¹‰structçš„æ—¶å€™ç”¨åå¼•å·å†™å‡ºæ¥å°±å¥½äº†ã€‚</p>
<h3 id="å®šä¹‰GraphQLæŸ¥è¯¢"><a class="headerlink" href="#å®šä¹‰GraphQLæŸ¥è¯¢" title="å®šä¹‰GraphQLæŸ¥è¯¢"></a>å®šä¹‰GraphQLæŸ¥è¯¢</h3><p>åŒæ ·ç”¨<code>GraphQL.newObject</code>æ¥å®šä¹‰ï¼š</p>
<p>å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> QueryType = graphql.NewObject(graphql.ObjectConfig{</span><br/><span class="line">	Name: <span class="string">"Query"</span>,</span><br/><span class="line">	Fields: graphql.Fields{</span><br/><span class="line">		<span class="string">"UserInfo"</span>: &amp;graphql.Field{</span><br/><span class="line">			Description: <span class="string">"[ç”¨æˆ·ç®¡ç†] è·å–æŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯"</span>,</span><br/><span class="line">			Type:        UserInfoType,</span><br/><span class="line">			Args: graphql.FieldConfigArgument{</span><br/><span class="line">                <span class="comment">// è¦æ±‚å‰ç«¯æŸ¥è¯¢æ—¶ä½¿ç”¨çš„å‚æ•°</span></span><br/><span class="line">                <span class="comment">// ä¾‹å¦‚è¿™ä¸ªæŸ¥è¯¢å°±è¦æ±‚å‰ç«¯å†™ï¼š</span></span><br/><span class="line">                <span class="comment">// UserInfo(userID:2) { ... }</span></span><br/><span class="line">				<span class="string">"userID"</span>: &amp;graphql.ArgumentConfig{</span><br/><span class="line">					Description: <span class="string">"ç”¨æˆ·ID"</span>,</span><br/><span class="line">					Type:        graphql.NewNonNull(graphql.Int),</span><br/><span class="line">				},</span><br/><span class="line">			},</span><br/><span class="line">            <span class="comment">// å®é™…çš„æŸ¥è¯¢é€»è¾‘</span></span><br/><span class="line">			Resolve: <span class="function"><span class="keyword">func</span><span class="params">(p graphql.ResolveParams)</span> <span class="params">(<span class="keyword">interface</span>{}, error)</span></span> {</span><br/><span class="line">                <span class="comment">// å¦‚æœè¦åšé‰´æƒï¼Œå¯ä»¥åœ¨è¿™é‡Œåš</span></span><br/><span class="line">                <span class="comment">// å¦‚è·å–jwt tokenï¼Œå¯ä»¥</span></span><br/><span class="line">                <span class="comment">// fmt.Println(p.Context.Value("token"))</span></span><br/><span class="line">                <span class="comment">// è¿™é‡Œçš„tokenè¦ä»å¤–é¢ä¼ å…¥</span></span><br/><span class="line">                <span class="comment">// ä¸‹é¢ä¼šè¯´</span></span><br/><span class="line">				userId := p.Args[<span class="string">"userID"</span>]</span><br/><span class="line">                <span class="comment">// è¿™é‡Œä½¿ç”¨beegoçš„ormï¼Œæ¢æˆå…¶ä»–ormæˆ–è€…raw SQLç”šè‡³ä»å†…å­˜ä¸­å–æ•°æ®éƒ½å¯ä»¥</span></span><br/><span class="line">				orm_ := orm.NewOrm()</span><br/><span class="line">				user := User{Id: <span class="keyword">uint64</span>(userId.(<span class="keyword">int</span>))}</span><br/><span class="line">				orm_.Read(&amp;user)</span><br/><span class="line">                <span class="comment">// æ³¨æ„è¿™é‡Œï¼Œä¸éœ€è¦ç®¡å‰ç«¯é—®æˆ‘ä»¬è¦çš„æ˜¯Idå­—æ®µã€CardIdå­—æ®µè¿˜æ˜¯ä¸¤ä¸ªéƒ½è¦</span></span><br/><span class="line">                <span class="comment">// æˆ‘ä»¬è¿”å›çš„å°±åªæ˜¯ä¸€ä¸ªuserå¯¹è±¡è€Œå·²</span></span><br/><span class="line">				<span class="keyword">return</span> user, <span class="literal">nil</span></span><br/><span class="line">			},</span><br/><span class="line">		},</span><br/><span class="line">	},</span><br/><span class="line">})</span><br/></pre></td></tr></table></figure>
<h3 id="å®šä¹‰GraphQLä¿®æ”¹"><a class="headerlink" href="#å®šä¹‰GraphQLä¿®æ”¹" title="å®šä¹‰GraphQLä¿®æ”¹"></a>å®šä¹‰GraphQLä¿®æ”¹</h3><p>åŒæ ·ç”¨<code>GraphQL.newObject</code>æ¥å®šä¹‰ï¼š</p>
<p>å¦‚ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> MutationType = graphql.NewObject(</span><br/><span class="line">	graphql.ObjectConfig{</span><br/><span class="line">		Name: <span class="string">"userMutation"</span>,</span><br/><span class="line">		Fields: graphql.Fields{</span><br/><span class="line">			<span class="string">"addUser"</span>: &amp;graphql.Field{</span><br/><span class="line">				Type: InfoType,</span><br/><span class="line">				Args: graphql.FieldConfigArgument{</span><br/><span class="line">					<span class="string">"CardId"</span>: &amp;graphql.ArgumentConfig{</span><br/><span class="line">						Description: <span class="string">"ç”¨æˆ·æ ¡å›­å¡å·"</span>,</span><br/><span class="line">						Type:        graphql.String,</span><br/><span class="line">					},</span><br/><span class="line">					<span class="string">"NickName"</span>: &amp;graphql.ArgumentConfig{</span><br/><span class="line">						Description: <span class="string">"ç”¨æˆ·æ˜µç§°"</span>,</span><br/><span class="line">						Type:        graphql.String,</span><br/><span class="line">					},</span><br/><span class="line">				},</span><br/><span class="line">				Resolve: <span class="function"><span class="keyword">func</span><span class="params">(p graphql.ResolveParams)</span> <span class="params">(<span class="keyword">interface</span>{}, error)</span></span> {</span><br/><span class="line">					newUser := User{</span><br/><span class="line">						CardId:   p.Args[<span class="string">"CardId"</span>].(<span class="keyword">string</span>),</span><br/><span class="line">						NickName: p.Args[<span class="string">"NickName"</span>].(<span class="keyword">string</span>),</span><br/><span class="line">					}</span><br/><span class="line">					orm_ := orm.NewOrm()</span><br/><span class="line">					orm_.Insert(&amp;newUser)</span><br/><span class="line">					<span class="keyword">return</span> newUser, <span class="literal">nil</span></span><br/><span class="line">				},</span><br/><span class="line">			},</span><br/><span class="line">		},</span><br/><span class="line">	},</span><br/><span class="line">)</span><br/></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨"><a class="headerlink" href="#ä½¿ç”¨" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>å…ˆå®šä¹‰Schemaï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Schema, _ = graphql.NewSchema(</span><br/><span class="line">   graphql.SchemaConfig{</span><br/><span class="line">      Query:    models.QueryType,</span><br/><span class="line">      Mutation: models.MutationType,</span><br/><span class="line">   },</span><br/><span class="line">)</span><br/></pre></td></tr></table></figure>
<p>å†å†™HTTPHandlerFuctionï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> {</span><br/><span class="line">		requestContent, _ := ioutil.ReadAll(r.Body)</span><br/><span class="line">    	<span class="comment">// æå–jwt</span></span><br/><span class="line">		token, _ := request.AuthorizationHeaderExtractor.ExtractToken(r)</span><br/><span class="line">		result := graphql.Do(graphql.Params{</span><br/><span class="line">			Schema:        Schema,</span><br/><span class="line">			RequestString: <span class="keyword">string</span>(requestContent),</span><br/><span class="line">            <span class="comment">// è¿™é‡Œæ˜¯æ’å…¥jwtç”¨äºé‰´æƒçš„æ“ä½œ</span></span><br/><span class="line">			Context:       context.WithValue(context.Background(), <span class="string">"token"</span>, token),</span><br/><span class="line">		})</span><br/><span class="line">		json.NewEncoder(w).Encode(result)</span><br/><span class="line">}</span><br/></pre></td></tr></table></figure>
<p>å³å¯ç”¨<code>ServeMux</code>çš„æ–¹å¼serveå‡ºå»ã€‚</p>

