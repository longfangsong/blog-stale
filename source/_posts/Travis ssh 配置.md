---
title: Travis ssh 配置
date: 2019-04-18 00:00:00
tags: [CI, CD, DevOps]
mathjax: true
comments: true
summary: Travis是我们喜(唯)闻(一)乐(会)见(用)的CI/CD工具，其中CD的功能个人习惯是ssh上目标服务器跑个脚本，本文讲述了Travis中ssh的配置。
---
<h2 id="生成（加密过的）SSH-key"><a class="headerlink" href="#生成（加密过的）SSH-key" title="生成（加密过的）SSH key"></a>生成（加密过的）SSH key</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -C 'build@travis-ci.com' -f ./deploy_rsa</span><br/><span class="line">travis encrypt-file --com deploy_rsa --add</span><br/><span class="line">ssh-copy-id -i deploy_rsa.pub 目标服务器用户名@目标服务器</span><br/></pre></td></tr></table></figure>
<p>然后你的<code>.travis.yml</code>中会出现：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="attr">before_install:</span></span><br/><span class="line"><span class="bullet">-</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="bullet">-K</span> <span class="string">$encrypted_......_key</span> <span class="bullet">-iv</span> <span class="string">$encrypted_......_iv</span></span><br/><span class="line"><span class="bullet">  -</span><span class="string">in</span> <span class="string">deploy_rsa.enc</span> <span class="bullet">-out</span> <span class="string">deploy_rsa</span> <span class="bullet">-d</span></span><br/></pre></td></tr></table></figure>
<p>同时 <code>$encrypted……key</code> 和 <code>$encrypted……iv</code> 会出现在你的travis CI项目的环境变量中。</p>
<p>一般我会把这段移到deploy stage里面：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line"><span class="attr">- stage:</span> <span class="string">deploy</span></span><br/><span class="line">	<span class="attr">language:</span> <span class="string">minimal</span></span><br/><span class="line">	<span class="attr">before_install:</span></span><br/><span class="line">		<span class="bullet">-</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="bullet">-K</span> <span class="string">$encrypted_......_key</span> <span class="bullet">-iv</span> <span class="string">$encrypted_......_iv</span></span><br/><span class="line">  		<span class="bullet">-in</span> <span class="string">deploy_rsa.enc</span> <span class="bullet">-out</span> <span class="string">deploy_rsa</span> <span class="bullet">-d</span></span><br/></pre></td></tr></table></figure>
<p>另外还需要在后面添加<code>key</code>文件权限的设置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">eval</span> <span class="string">"$(ssh-agent -s)"</span></span><br/><span class="line"><span class="bullet">-</span> <span class="string">chmod</span> <span class="number">600</span> <span class="string">./deploy_rsa</span></span><br/><span class="line"><span class="bullet">-</span> <span class="string">ssh-add</span> <span class="string">./deploy_rsa</span></span><br/></pre></td></tr></table></figure>
<h2 id="添加known-hosts"><a class="headerlink" href="#添加known-hosts" title="添加known_hosts"></a>添加<code>known_hosts</code></h2><p>为了防止让<code>ssh</code>让你拿手选是否把你的目标服务器添加到<code>known_hosts</code>，造成CD不能继续，我们还要在<code>.travis.yml</code>头部添加（我一般加在<code>services</code>一项的后面）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="attr">addons:</span></span><br/><span class="line"><span class="attr">  ssh_known_hosts:</span> <span class="string">目标服务器</span></span><br/></pre></td></tr></table></figure>
<p>接着删掉我们不该上传的东西：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">rm -f deploy_rsa deploy_rsa.pub</span><br/></pre></td></tr></table></figure>
<p>你也可以将这两个文件添加到<code>.gitignore</code>中，防止以后接手的人做出什么傻事（x。</p>
<p>然后将需要上传的东西添加到git里：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">git add deploy_rsa.enc</span><br/></pre></td></tr></table></figure>
<h2 id="添加实际需要运行的东西"><a class="headerlink" href="#添加实际需要运行的东西" title="添加实际需要运行的东西"></a>添加实际需要运行的东西</h2><p>在<code>.travis.yml</code>的deploy stage中写：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/></pre></td><td class="code"><pre><span class="line"><span class="attr">- stage:</span> <span class="string">deploy</span></span><br/><span class="line">	<span class="attr">language:</span> <span class="string">minimal</span></span><br/><span class="line">	<span class="attr">before_install:</span></span><br/><span class="line">		<span class="bullet">-</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="bullet">-K</span> <span class="string">$encrypted_......_key</span> <span class="bullet">-iv</span> <span class="string">$encrypted_......_iv</span></span><br/><span class="line">  		<span class="bullet">-in</span> <span class="string">deploy_rsa.enc</span> <span class="bullet">-out</span> <span class="string">deploy_rsa</span> <span class="bullet">-d</span></span><br/><span class="line">  	<span class="bullet">-</span> <span class="string">eval</span> <span class="string">"$(ssh-agent -s)"</span></span><br/><span class="line">		<span class="bullet">-</span> <span class="string">chmod</span> <span class="number">600</span> <span class="string">./deploy_rsa</span></span><br/><span class="line">		<span class="bullet">-</span> <span class="string">ssh-add</span> <span class="string">./deploy_rsa</span></span><br/><span class="line">	<span class="attr">script:</span></span><br/><span class="line">  	<span class="bullet">-</span> <span class="string">ssh</span> <span class="bullet">-i</span> <span class="string">./deploy_rsa</span> <span class="string">目标服务器用户名@目标服务器</span> <span class="string">部署时要执行的指令</span></span><br/></pre></td></tr></table></figure>
<p>个人习惯把要执行的指令写成一整个shell脚本，然后只需在<code>ssh</code>中调用这个脚本即可。</p>
<p>当然也可以一句句语句通过<code>ssh</code>执行，随你的需求和喜好而定了。</p>
<p>接着commit and push你的代码，and enjoy！</p>

